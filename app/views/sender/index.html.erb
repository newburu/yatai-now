<div class="min-h-screen bg-gray-100 flex flex-col justify-center py-12 sm:px-6 lg:px-8">
  <div class="sm:mx-auto sm:w-full sm:max-w-md">
    <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
      <%= t(".title") %>
    </h2>
    <p class="mt-2 text-center text-sm text-gray-600">
      <%= sanitize(t(".description")) %>
    </p>
  </div>

    <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
      <div class="bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10">
        <div class="space-y-6">
          <div>
            <label for="auth_code" class="block text-sm font-medium text-gray-700">
              <%= t(".auth_code_label") %>
            </label>
          <div class="mt-1">
            <input id="auth_code" name="auth_code" type="text" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="例: A-chiku-1234">
          </div>
        </div>

          <div class="flex space-x-4">
            <button id="start_sending" type="button" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400 disabled:cursor-not-allowed">
              <%= t(".start_sending") %>
            </button>
            <button id="stop_sending" type="button" disabled class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:bg-gray-400 disabled:cursor-not-allowed">
              <%= t(".stop_sending") %>
            </button>
          </div>

          <div class="mt-4">
            <div id="status" class="p-4 rounded-md bg-gray-50 border border-gray-200 text-center font-medium text-gray-700">
              <%= t(".status_stopped") %>
            </div>
          </div>
        </div>
      </div>
    </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const startButton = document.getElementById('start_sending');
    const stopButton = document.getElementById('stop_sending');
    const authCodeInput = document.getElementById('auth_code');
    const statusDiv = document.getElementById('status');

    let watchId = null; // GPS監視ID
    let intervalId = null; // 定期送信用ID
    let lastPosition = null; // 最後に取得した位置情報

    const SEND_INTERVAL = 30000; // 30秒ごとに送信

    // GPS監視を開始
    function startWatching() {
      if ('geolocation' in navigator) {
        watchId = navigator.geolocation.watchPosition(
          (position) => {
            // 成功：最新の位置情報を保存
            lastPosition = position;
            updateStatus(`<%= j t(".status_getting_location") %><br>
              <%= j t(".latitude") %>: ${position.coords.latitude.toFixed(6)}<br>
              <%= j t(".longitude") %>: ${position.coords.longitude.toFixed(6)}`);
          },
          (error) => {
            // 失敗
            updateStatus(`<%= j t(".status_error") %>: ${error.message}`, true);
          },
          {
            enableHighAccuracy: true, // 高精度モード
            timeout: 10000, // 10秒でタイムアウト
            maximumAge: 0 // キャッシュを使わない
          }
        );
      } else {
        updateStatus('<%= j t(".alert_gps_not_supported") %>', true);
      }
    }

    // 定期送信を開始
    function startSending() {
      const authCode = authCodeInput.value.trim();
      if (authCode === "") {
        alert('<%= j t(".alert_enter_auth_code") %>');
        return;
      }
      if (!lastPosition) {
         alert('<%= j t(".alert_waiting_for_gps") %>');
         return;
      }

      // 定期的にサーバーへPOSTする
      intervalId = setInterval(() => {
        if (lastPosition) {
          sendLocation(authCode, lastPosition.coords);
        }
      }, SEND_INTERVAL);

      // UIの更新
      updateStatus('<%= j t(".status_started") %>', false, 'bg-blue-50', 'text-blue-700');
      startButton.disabled = true;
      stopButton.disabled = false;
      authCodeInput.disabled = true;
    }

    // サーバーへ位置情報を送信 (fetch API)
    async function sendLocation(authCode, coords) {
      const postData = {
        auth_code: authCode,
        latitude: coords.latitude,
        longitude: coords.longitude
      };

      try {
        const response = await fetch('/api/v1/locations', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // Rails APIは 'X-CSRF-Token' ヘッダを要求しない設定にしたので不要
          },
          body: JSON.stringify(postData)
        });

        const result = await response.json();

        if (response.ok) {
          updateStatus(`<%= j t(".status_success") %> (${new Date().toLocaleTimeString()})<br>
                       <%= j t(".latitude") %>: ${coords.latitude.toFixed(6)}<br>
                       <%= j t(".longitude") %>: ${coords.longitude.toFixed(6)}`, false, 'bg-green-50', 'text-green-700');
        } else {
          updateStatus(`<%= j t(".status_send_error") %>: ${result.message || '<%= j t(".status_server_error") %>'}`, true);
          stopWatchingAndSending(); // 認証エラーなら停止
        }
      } catch (error) {
        updateStatus(`<%= j t(".status_network_error") %>: ${error.message}`, true);
      }
    }

    // すべて停止
    function stopWatchingAndSending() {
      if (watchId) navigator.geolocation.clearWatch(watchId);
      if (intervalId) clearInterval(intervalId);

      watchId = null;
      intervalId = null;
      lastPosition = null;

      // UIを初期状態に戻す
      updateStatus('<%= j t(".status_stopped") %>');
      startButton.disabled = false;
      stopButton.disabled = true;
      authCodeInput.disabled = false;
    }

    // ステータス表示更新ヘルパー
    function updateStatus(message, isError = false, bgClass = 'bg-gray-50', textClass = 'text-gray-700') {
      statusDiv.innerHTML = message;
      statusDiv.className = `p-4 rounded-md border border-gray-200 text-center font-medium ${isError ? 'bg-red-50 text-red-700' : `${bgClass} ${textClass}`}`;
    }

    // --- イベントリスナー ---

    // 「送信開始」ボタン
    startButton.addEventListener('click', () => {
      // まずGPS監視を開始
      startWatching();
      // 次に定期送信を開始
      startSending();
    });

    // 「送信停止」ボタン
    stopButton.addEventListener('click', stopWatchingAndSending);
  });
</script>
